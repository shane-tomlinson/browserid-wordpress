(function(){"use strict";function a(e){return e||"login"}function f(e){t=e;var n={siteName:browserid_common.siteName||"",siteLogo:browserid_common.siteLogo||"",backgroundColor:browserid_common.backgroundColor||"",termsOfService:browserid_common.termsOfService||"",privacyPolicy:browserid_common.privacyPolicy||""};if(t==="comment"){n.returnTo=w("#submit_comment")}else if(t==="register"){n.returnTo=w("#submit_registration")}navigator.id.request(n)}function l(t){var n=document.getElementById("rememberme");if(n!==null)n=n.checked;var r=document.createElement("form");r.setAttribute("style","display: none;");r.method="POST";r.action=browserid_common.urlLoginSubmit;var i={browserid_assertion:t,rememberme:n};if(browserid_common.urlLoginRedirect!==null)i.redirect_to=browserid_common.urlLoginRedirect;E(r,i);e("body").append(r);r.submit()}function c(){r=true;p();f("comment")}function h(t){var i=d();if(!(i||n))return v();var o=e("#commentform");var u=e("#comment_post_ID").val();E(o,{browserid_comment:u,browserid_assertion:t});localStorage.removeItem("comment_hash");sessionStorage.setItem("submitting_comment","true");if(!browserid_common.loggedInUser){r=true;navigator.id.logout()}s=true;e("#submit").click()}function p(){var t={author:e("#author").val(),url:e("#url").val(),comment:e("#comment").val(),comment_parent:e("#comment_parent").val()};localStorage.setItem("comment_state",JSON.stringify(t))}function d(){var t=localStorage.getItem("comment_state");if(t){t=JSON.parse(t);e("#author").val(t.author);e("#url").val(t.url);e("#comment").val(t.comment);e("#comment_parent").val(t.comment_parent);localStorage.removeItem("comment_state")}return t}function v(){var e=localStorage.getItem("comment_hash");if(e){localStorage.removeItem("comment_hash");document.location.hash=e;document.location.reload(true)}else{setTimeout(v,100)}}function m(t){var r=y();if(!(r||n))return b();sessionStorage.setItem("submitting_registration","true");e("#browserid_assertion").val(t);i=true;e("#wp-submit").click()}function g(){var t={user_login:e("#user_login").val()};localStorage.setItem("registration_state",JSON.stringify(t))}function y(){var t=localStorage.getItem("registration_state");if(t){t=JSON.parse(t);e("#user_login").val(t.user_login);localStorage.removeItem("registration_state")}return t}function b(){var e=localStorage.getItem("registration_complete");if(e){localStorage.removeItem("registration_complete");document.location=browserid_common.urlRegistrationRedirect}else{setTimeout(b,100)}}function w(e){return document.location.href.replace(/http(s)?:\/\//,"").replace(document.location.host,"").replace(/#.*$/,"")+e}function E(t,n){t=e(t);for(var r in n){var i=document.createElement("input");i.type="hidden";i.name=r;i.value=n[r];t.append(i)}}function S(){var t=e("<div class='persona__submit'><div class='persona__submit_spinner'></div></div>");e("body").append(t)}function x(t,n){function r(){var r=e(t).val();if(r&&r.trim().length){e(n).removeClass("disabled")}else{e(n).addClass("disabled")}}e(n).addClass("disabled");e(t).keyup(r);e(t).change(r)}function T(t,n,r){e("body")[typeof e.fn.on==="function"?"on":"delegate"](n,t,r)}var e=jQuery;var t;var n;var r=false;var i=false;var s=browserid_common.loggedInUser||false;var o;e(".js-persona__login").click(function(e){e.preventDefault();r=false;f("login")});T(".js-persona__logout","click",function(e){r=false;navigator.id.logout()});if(browserid_common.isPersonaUsedWithComments){e("body").addClass("persona--comments");e(".js-persona__submit-comment").click(function(t){t.preventDefault();e("#commentform").submit()});e("#commentform").submit(function(t){if(e("#comment").hasClass("disabled")){t.preventDefault();return}if(!s){t.preventDefault();c()}})}if(browserid_common.isPersonaOnlyAuth){e("body").addClass("persona--persona-only-auth");x("#user_login",".js-persona__register");e(".js-persona__register").click(function(t){t.preventDefault();if(e(t.target).hasClass("disabled"))return;r=false;g();f("register")});e("#registerform").submit(function(t){if(i)return;t.preventDefault();if(e("#user_login").val().length===0)return;r=false;g();f("register")})}if(document.location.hash==="#submit_comment"){r=true;S();o=d();if(!o)return v();t="comment";n=true}else if(document.location.hash==="#submit_registration"){r=true;S();o=y();if(!o)return b();t="register";n=true}else if(document.location.href===browserid_common.urlRegistrationRedirect&&sessionStorage.getItem("submitting_registration")){localStorage.setItem("registration_complete","true")}else if(sessionStorage.getItem("submitting_comment")){r=true;sessionStorage.removeItem("submitting_comment");localStorage.setItem("comment_hash",document.location.hash)}if(browserid_common.msgError||e("#login_error").length){r=true;navigator.id.logout()}var u={login:l,register:m,comment:h};navigator.id.watch({loggedInUser:browserid_common.loggedInUser||null,onlogin:function(e){t=a(t);var n=u[t];if(n){n(e)}},onlogout:function(){if(r)return}})})()
